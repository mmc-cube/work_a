<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ESP32S3 æ§åˆ¶é¢æ¿</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --pri:#2563eb; --pri2:#1d4ed8; --ok:#16a34a; --bad:#e11d48; --warn:#f59e0b;
      --shadow:0 6px 18px rgba(15, 23, 42, .06);
      --appTop: 74px; /* â­ é¡¶éƒ¨ç•™ç™½ï¼šè¢«ä½ Appä¸Šæ–¹æ¡†é®æŒ¡çš„è¯ï¼ŒæŠŠè¿™é‡Œè°ƒå¤§/è°ƒå° */
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      padding-top: var(--appTop);
    }
    .wrap{ max-width:1080px; margin:0 auto; padding:14px 14px 40px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:12px;
    }
    .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .title h1{ margin:0; font-size:18px; font-weight:800; letter-spacing:.2px; }
    .title .sub{ color:var(--muted); font-size:12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--card); border:1px solid var(--line); border-radius:999px;
      padding:8px 10px; box-shadow:var(--shadow);
      font-size:12px; color:var(--muted);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--bad); }
    .dot.ok{ background:var(--ok); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      box-shadow:var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .card.alarm{
      border-color: rgba(225,29,72,.35);
      box-shadow: 0 8px 24px rgba(225,29,72,.12);
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:10px;
    }
    .cardHead .name{
      font-weight:800; font-size:14px;
      display:flex; align-items:center; gap:8px;
    }
    .tag{
      display:none;
      font-size:11px; font-weight:800;
      padding:3px 8px; border-radius:999px;
      color:#fff; background:var(--bad);
    }
    .tag.warn{ background:var(--warn); color:#111; }

    .kpi{
      display:flex; align-items:baseline; gap:10px;
      margin:6px 0 12px;
    }
    .kpi .num{ font-size:34px; font-weight:900; letter-spacing:-.5px; }
    .kpi .unit{ color:var(--muted); font-weight:700; font-size:12px; }

    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
      padding-top:10px; border-top:1px dashed var(--line);
    }

    .mini{
      display:flex; flex-direction:column; gap:4px;
      font-size:12px; color:var(--muted);
    }
    .mini b{ color:var(--text); font-size:13px; }

    .ctrl{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      margin-top:10px;
    }
    .btn{
      border:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      background:var(--pri);
      color:#fff;
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
      transition:transform .06s ease, filter .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background:#0f172a; color:#fff;
      box-shadow:0 10px 20px rgba(2,6,23,.18);
    }
    .btn.ghost{
      background:#f1f5f9; color:#0f172a; box-shadow:none; border:1px solid var(--line);
    }
    .btn.bad{ background:var(--bad); box-shadow:0 10px 20px rgba(225,29,72,.18); }
    .btn.ok{ background:var(--ok); box-shadow:0 10px 20px rgba(22,163,74,.18); }

    .form{
      display:grid; grid-template-columns: 1fr 1fr; gap:10px;
      margin-top:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{ font-size:12px; color:var(--muted); font-weight:700; }
    .field input{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .field input:focus{ border-color: rgba(37,99,235,.45); box-shadow:0 0 0 4px rgba(37,99,235,.12); }
    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      min-height: 1.2em;
    }
    .footer{
      margin-top:14px;
      font-size:12px; color:var(--muted);
      text-align:center;
    }

    /* è®©ç§»åŠ¨ç«¯æŒ‰é’®æ›´å¥½ç‚¹ */
    @media (max-width: 420px){
      .kpi .num{ font-size:30px; }
      .ctrl{ grid-template-columns:1fr; }
      .form{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>ESP32S3 æ§åˆ¶é¢æ¿</h1>
        <div class="sub">å®æ—¶æ˜¾ç¤ºï¼šMQ7 / ç«ç„°ç”µå‹ &nbsp;|&nbsp; é˜ˆå€¼ &nbsp;|&nbsp; æ°´æ³µæ§åˆ¶</div>
      </div>
      <div class="pill" title="è¿æ¥çŠ¶æ€">
        <span id="dot" class="dot"></span>
        <span id="connText">æœªè¿æ¥</span>
        <span id="lastTs" style="margin-left:8px;color:#94a3b8;"></span>
      </div>
    </div>

    <div class="grid">
      <div id="mq7Card" class="card">
        <div class="cardHead">
          <div class="name">
            MQ7
            <span id="mq7AlarmTag" class="tag">æŠ¥è­¦</span>
          </div>
          <div class="mini" style="text-align:right">
            <span>é˜ˆå€¼</span>
            <b><span id="mq7ThShow">--</span> V</b>
          </div>
        </div>
        <div class="kpi">
          <div class="num" id="mq7V">--</div>
          <div class="unit">V</div>
        </div>

        <div class="row">
          <div class="mini">
            <span>æç¤º</span>
            <b>â‰¥ é˜ˆå€¼è§¦å‘æŠ¥è­¦</b>
          </div>
          <button id="btnTestAlarmMq7" class="btn ghost" type="button">æ¨¡æ‹ŸæŠ¥è­¦</button>
        </div>
      </div>

      <div id="flameCard" class="card">
        <div class="cardHead">
          <div class="name">
            ç«ç„°ç”µå‹
            <span id="flameAlarmTag" class="tag warn">æŠ¥è­¦</span>
          </div>
          <div class="mini" style="text-align:right">
            <span>é˜ˆå€¼</span>
            <b><span id="flameThShow">--</span> V</b>
          </div>
        </div>
        <div class="kpi">
          <div class="num" id="flameV">--</div>
          <div class="unit">V</div>
        </div>

        <div class="row">
          <div class="mini">
            <span>æç¤º</span>
            <b>â‰¥ é˜ˆå€¼è§¦å‘æŠ¥è­¦</b>
          </div>
          <button id="btnTestAlarmFlame" class="btn ghost" type="button">æ¨¡æ‹ŸæŠ¥è­¦</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="name">é˜ˆå€¼è®¾ç½®</div>
          <span class="tag" style="display:inline-flex;background:#0f172a;">MQTT</span>
        </div>

        <div class="form">
          <div class="field">
            <label>MQ7 é˜ˆå€¼ (0~3.30V)</label>
            <input id="mq7ThIn" inputmode="decimal" placeholder="ä¾‹å¦‚ 2.00" />
          </div>
          <div class="field">
            <label>ç«ç„°é˜ˆå€¼ (0~3.30V)</label>
            <input id="flameThIn" inputmode="decimal" placeholder="ä¾‹å¦‚ 2.00" />
          </div>
        </div>

        <div class="ctrl">
          <button id="btnAuto" class="btn" type="button">è‡ªåŠ¨é˜ˆå€¼</button>
          <button id="btnManual" class="btn secondary" type="button">æ‰‹åŠ¨è®¾ç½®</button>
        </div>

        <div class="hint" id="hint">æç¤ºï¼šé˜ˆå€¼ä¼šå¤¹ç´§åˆ° 0~3.30ï¼Œç¦»å¼€è¾“å…¥æ¡†è‡ªåŠ¨ä¿å­˜ã€‚</div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="name">æ°´æ³µæ§åˆ¶</div>
          <span class="tag" style="display:inline-flex;background:var(--pri);">PUMP</span>
        </div>

        <div class="ctrl">
          <button id="btnPumpOn" class="btn ok" type="button">å¼€å¯</button>
          <button id="btnPumpOff" class="btn bad" type="button">å…³é—­</button>
          <button id="btnPumpToggle" class="btn ghost" type="button" style="grid-column:1 / -1">åˆ‡æ¢ï¼ˆtoggleï¼‰</button>
        </div>

        <div class="hint">è¯´æ˜ï¼šå‘é€ cmd=pump state=1/0 æˆ– toggle=1</div>
      </div>
    </div>

    <div class="footer">WebView å…¼å®¹ï¼šå»ºè®®é¦–æ¬¡æ‰“å¼€å…ˆç‚¹ä¸€æ¬¡ â€œæˆæƒ/è§£é”å£°éŸ³â€ ä»¥ç¡®ä¿èœ‚é¸£å¯ç”¨ã€‚</div>
  </div>

  <!-- MQTT.jsï¼ˆCDNï¼‰ -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <script>
  // =================== é…ç½®ï¼ˆæŒ‰ä½  ESP32/æœåŠ¡å™¨æ”¹ï¼‰ ===================
  const MQTT_URL = "wss://broker.emqx.io:8084/mqtt"; // ç¤ºä¾‹ï¼šå…¬å…± brokerï¼ˆä½ å¯æ›¿æ¢ï¼‰
  const MQTT_SUB_TOPIC = "esp32s3/sub";              // è®¾å¤‡ä¸ŠæŠ¥
  const MQTT_PUB_TOPIC = "esp32s3/pub";              // æ§åˆ¶ä¸‹å‘
  // ==================================================================

  const $ = (id) => document.getElementById(id);

  const dot = $("dot");
  const connText = $("connText");
  const lastTs = $("lastTs");
  const hint = $("hint");

  const mq7ThIn = $("mq7ThIn");
  const flameThIn = $("flameThIn");

  const btnAuto = $("btnAuto");
  const btnManual = $("btnManual");
  const btnPumpOn = $("btnPumpOn");
  const btnPumpOff = $("btnPumpOff");
  const btnPumpToggle = $("btnPumpToggle");

  const latest = { mq7_v:null, flame_v:null, mq7_th:null, flame_th:null };

  let client = null;

  function randomId(){
    return "web_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function clampV(v){
    if (Number.isNaN(v) || v==null) return null;
    return Math.max(0, Math.min(3.30, v));
  }

  function fmt2(v){
    if (v==null || Number.isNaN(Number(v))) return "--";
    return Number(v).toFixed(2);
  }

  function setConn(ok){
    dot.classList.toggle("ok", !!ok);
    connText.textContent = ok ? "å·²è¿æ¥" : "æœªè¿æ¥";
  }

  function persistInputs(){
    localStorage.setItem("mq7_th_in", mq7ThIn.value.trim());
    localStorage.setItem("flame_th_in", flameThIn.value.trim());
  }

  function restoreInputs(){
    mq7ThIn.value = localStorage.getItem("mq7_th_in") || "";
    flameThIn.value = localStorage.getItem("flame_th_in") || "";
  }

  function updateUI(){
    $("mq7V").textContent = fmt2(latest.mq7_v);
    $("flameV").textContent = fmt2(latest.flame_v);
    $("mq7ThShow").textContent = fmt2(latest.mq7_th);
    $("flameThShow").textContent = fmt2(latest.flame_th);

    const mq7Alarm = latest.mq7_v!=null && latest.mq7_th!=null && Number(latest.mq7_v) >= Number(latest.mq7_th);
    const flameAlarm = latest.flame_v!=null && latest.flame_th!=null && Number(latest.flame_v) >= Number(latest.flame_th);

    $("mq7Card").classList.toggle("alarm", mq7Alarm);
    $("mq7AlarmTag").style.display = mq7Alarm ? "inline-block" : "none";

    $("flameCard").classList.toggle("alarm", flameAlarm);
    $("flameAlarmTag").style.display = flameAlarm ? "inline-block" : "none";

    // æŠ¥è­¦æé†’ï¼ˆå¼¹çª—/èœ‚é¸£/éœ‡åŠ¨/é€šçŸ¥ï¼‰
    if (window.updateSensorValuesForAlarm) {
      window.updateSensorValuesForAlarm(latest.mq7_v, latest.flame_v, latest.mq7_th, latest.flame_th);
    }
  }

  function publish(obj){
    if (!client || !client.connected){
      hint.textContent = "æœªè¿æ¥ï¼Œæ— æ³•å‘é€";
      return;
    }
    try{
      client.publish(MQTT_PUB_TOPIC, JSON.stringify(obj), { qos:0, retain:false });
      hint.textContent = "å·²å‘é€: " + JSON.stringify(obj);
    }catch(e){
      hint.textContent = "å‘é€å¤±è´¥";
    }
  }

  // ====== æ¨¡æ‹ŸæŠ¥è­¦ï¼ˆä¾¿äºä½ æµ‹è¯• UIï¼‰======
  $("btnTestAlarmMq7").onclick = () => {
    latest.mq7_v = 2.50; latest.mq7_th = 2.00;
    updateUI();
  };
  $("btnTestAlarmFlame").onclick = () => {
    latest.flame_v = 2.60; latest.flame_th = 2.00;
    updateUI();
  };

  // ====== MQTT è¿æ¥ & æ”¶æ¶ˆæ¯ ======
  function connect(){
    if (client) { try{ client.end(true);}catch(_){} }
    hint.textContent = "è¿æ¥ä¸­â€¦";

    client = mqtt.connect(MQTT_URL, {
      clientId: randomId(),
      clean: true,
      keepalive: 30,
      connectTimeout: 10_000,
      reconnectPeriod: 2000,
    });

    client.on("connect", () => {
      setConn(true);
      client.subscribe(MQTT_SUB_TOPIC, { qos:0 });
      hint.textContent = "å·²è¿æ¥";
    });

    client.on("reconnect", () => { hint.textContent = "é‡è¿ä¸­â€¦"; });
    client.on("close", () => { setConn(false); });
    client.on("offline", () => { setConn(false); });
    client.on("error", () => { setConn(false); hint.textContent = "é”™è¯¯"; });

    client.on("message", (topic, message) => {
      if (topic !== MQTT_SUB_TOPIC) return;
      try{
        const data = JSON.parse(message.toString());

        // åªå–å›ºå®š 4 å­—æ®µ
        if ("mq7_v" in data) latest.mq7_v = clampV(Number(data.mq7_v));
        if ("flame_v" in data) latest.flame_v = clampV(Number(data.flame_v));
        if ("mq7_th" in data) latest.mq7_th = clampV(Number(data.mq7_th));
        if ("flame_th" in data) latest.flame_th = clampV(Number(data.flame_th));

        updateUI();
        lastTs.textContent = "last: " + new Date().toLocaleTimeString();
      }catch(_){}
    });
  }

  // ===== è¾“å…¥ï¼šç¦»å¼€è¾“å…¥æ¡†å°±å­˜ï¼Œå¹¶ä¸”è‡ªåŠ¨å¤¹ç´§åˆ° 0~3.30 =====
  function normalizeInput(el){
    const t = el.value.trim();
    if (!t) return;
    const v = clampV(Number(t));
    el.value = (v==null) ? "" : v.toFixed(2);
    persistInputs();
  }
  mq7ThIn.addEventListener("blur", () => normalizeInput(mq7ThIn));
  flameThIn.addEventListener("blur", () => normalizeInput(flameThIn));

  // ====== æŒ‰é’®äº‹ä»¶ ======
  btnAuto.onclick = () => publish({ cmd:"auto_threshold" });

  btnManual.onclick = () => {
    const mq7 = mq7ThIn.value.trim();
    const fl = flameThIn.value.trim();

    const cmd = { cmd:"manual_threshold" };
    if (mq7 !== "") cmd.mq7_th = clampV(Number(mq7));
    if (fl !== "")  cmd.flame_th = clampV(Number(fl));

    // è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆå­—æ®µ
    if (!("mq7_th" in cmd) && !("flame_th" in cmd)) { hint.textContent="è¯·è¾“å…¥é˜ˆå€¼"; return; }

    // å»æ‰ null
    if (cmd.mq7_th == null) delete cmd.mq7_th;
    if (cmd.flame_th == null) delete cmd.flame_th;

    publish(cmd);
  };

  btnPumpOn.onclick = () => publish({ cmd:"pump", state:1 });
  btnPumpOff.onclick = () => publish({ cmd:"pump", state:0 });
  btnPumpToggle.onclick = () => publish({ cmd:"pump", toggle:1 });

  // é¡µé¢æ˜¾ç¤º/æ¢å¤æ—¶ï¼Œç¡®ä¿è¿æ¥å­˜åœ¨ï¼ˆWebView åˆ‡åå°å†å›æ¥å¸¸è§ï¼‰
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
      // è‹¥å·²æ–­å¼€åˆ™è§¦å‘é‡è¿
      if (!client || !client.connected) connect();
    }
  });

  // ===================== æŠ¥è­¦æé†’ï¼ˆå¼¹çª—/èœ‚é¸£/éœ‡åŠ¨/é€šçŸ¥ï¼‰ =====================
  // è¯´æ˜ï¼š
  // - è§¦å‘æ¡ä»¶ï¼šmq7_v >= mq7_th æˆ– flame_v >= flame_thï¼ˆé˜ˆå€¼æ¥è‡ªè®¾å¤‡ä¸ŠæŠ¥ latest.*_thï¼›è‹¥æ— åˆ™ç”¨è¾“å…¥æ¡†å€¼ï¼‰
  // - è¾¹æ²¿è§¦å‘ï¼šä»æœªè¶…é˜ˆå€¼ -> è¶…é˜ˆå€¼ æ‰ä¼šè§¦å‘ä¸€æ¬¡ï¼Œé¿å…ç–¯ç‹‚é‡å¤æŠ¥è­¦
  // - å¯â€œç¨å 5 åˆ†é’Ÿâ€æš‚åœæŠ¥è­¦ï¼›å¯å‹¾é€‰â€œä¿æŒç›´åˆ°ç¡®è®¤â€é˜²æ­¢æ¢å¤åè‡ªåŠ¨åœæ­¢
  (function initAlarm(){
    const SNOOZE_MS = 5 * 60 * 1000;

    let alarmActive = false;
    let snoozeUntil = 0;
    let audioCtx = null;
    let beepTimer = null;
    let lastOver = { mq7:false, flame:false };

    const $ = (id) => document.getElementById(id);
    const overlay = $("alarmOverlay");
    const msgBox  = $("alarmMessage");
    const hint    = $("alarmHint");

    if (!overlay) return; // æ²¡æ’å…¥ overlay å°±ä¸åˆå§‹åŒ–

    const enableChk  = $("alarmEnableChk");
    const soundChk   = $("alarmSoundChk");
    const vibrateChk = $("alarmVibrateChk");
    const notifyChk  = $("alarmNotifyChk");
    const holdChk    = $("alarmHoldChk");

    function ensureAudioContext(){
      if (!audioCtx){
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return null;
        audioCtx = new Ctx();
      }
      return audioCtx;
    }

    async function unlockAudio(){
      const ctx = ensureAudioContext();
      if (!ctx){ hint.textContent="å½“å‰ç¯å¢ƒä¸æ”¯æŒ WebAudioï¼Œæ— æ³•èœ‚é¸£ã€‚"; return; }
      try{
        if (ctx.state === "suspended") await ctx.resume();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = "sine";
        osc.frequency.value = 880;
        gain.gain.value = 0.0001; // æå°éŸ³é‡ï¼Œä»…ç”¨äºè§£é”
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.02);
        hint.textContent = "å£°éŸ³å·²è§£é” âœ…ï¼ˆä¹‹åæŠ¥è­¦å¯èœ‚é¸£ï¼‰";
      }catch(e){
        hint.textContent = "è§£é”å£°éŸ³å¤±è´¥ï¼ˆWebView å¯èƒ½é™åˆ¶è‡ªåŠ¨æ’­æ”¾ï¼‰ã€‚è¯·å†ç‚¹ä¸€æ¬¡ã€‚";
      }
    }

    function startBeepLoop(){
      if (!soundChk.checked) return;
      const ctx = ensureAudioContext();
      if (!ctx) return;
      if (beepTimer) return;

      beepTimer = setInterval(() => {
        try{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "square";
          osc.frequency.value = 880;
          gain.gain.value = 0.12;
          osc.connect(gain); gain.connect(ctx.destination);
          osc.start(); osc.stop(ctx.currentTime + 0.2);
        }catch(_){}
      }, 900);
    }

    function stopBeepLoop(){
      if (beepTimer) clearInterval(beepTimer);
      beepTimer = null;
    }

    function vibratePattern(){
      if (!vibrateChk.checked) return;
      if (navigator.vibrate) navigator.vibrate([250,120,250,120,400]);
    }

    async function tryNotify(title, body){
      if (!notifyChk.checked) return;
      if (!("Notification" in window)) return;
      try{
        if (Notification.permission === "default"){
          await Notification.requestPermission();
        }
        if (Notification.permission === "granted"){
          new Notification(title, { body });
        }
      }catch(_){}
    }

    function showAlarm(message){
      overlay.style.display = "flex";
      msgBox.textContent = message;
    }

    function hideAlarm(){
      overlay.style.display = "none";
    }

    function triggerAlarm(reasonText){
      const now = Date.now();
      if (!enableChk.checked) return;
      if (now < snoozeUntil) return;
      if (alarmActive) return;

      alarmActive = true;
      showAlarm(reasonText);
      startBeepLoop();
      vibratePattern();
      tryNotify("æŠ¥è­¦æé†’", reasonText);
    }

    function stopAlarm({ keepOverlay=false } = {}){
      alarmActive = false;
      stopBeepLoop();
      if (!keepOverlay) hideAlarm();
    }

    $("alarmUnlockAudioBtn").addEventListener("click", unlockAudio);
    $("alarmAckBtn").addEventListener("click", () => stopAlarm({ keepOverlay:false }));
    $("alarmStopBtn").addEventListener("click", () => stopAlarm({ keepOverlay:false }));
    $("alarmCloseBtn").addEventListener("click", hideAlarm);

    $("alarmSnoozeBtn").addEventListener("click", () => {
      snoozeUntil = Date.now() + SNOOOZE_MS;
      hint.textContent = "å·²ç¨å 5 åˆ†é’Ÿã€‚";
      stopAlarm({ keepOverlay:false });
    });

    $("alarmTestBtn").addEventListener("click", () => {
      triggerAlarm("è¿™æ˜¯ä¸€æ¬¡æµ‹è¯•æŠ¥è­¦ï¼ˆæ£€æŸ¥å£°éŸ³/éœ‡åŠ¨/å¼¹çª—/é€šçŸ¥ï¼‰");
    });

    soundChk.addEventListener("change", () => {
      if (!soundChk.checked) stopBeepLoop();
      else if (alarmActive) startBeepLoop();
    });

    // å¯¹å¤–æš´éœ²ï¼šå–‚ä¼ æ„Ÿå™¨å€¼ + é˜ˆå€¼ï¼ˆé˜ˆå€¼å¯é€‰ï¼‰
    window.updateSensorValuesForAlarm = function(mq7_v, flame_v, mq7_th, flame_th){
      const mq7  = Number(mq7_v);
      const fl   = Number(flame_v);
      const thMq7 = (mq7_th!=null && mq7_th!=="" && !Number.isNaN(Number(mq7_th))) ? Number(mq7_th) : null;
      const thFl  = (flame_th!=null && flame_th!=="" && !Number.isNaN(Number(flame_th))) ? Number(flame_th) : null;

      // è‹¥é˜ˆå€¼æ²¡ä¼ ï¼Œå°±ä»è¾“å…¥æ¡†å–
      const mq7ThFallback = (typeof mq7ThIn !== "undefined") ? Number(mq7ThIn.value) : null;
      const flThFallback  = (typeof flameThIn !== "undefined") ? Number(flameThIn.value) : null;

      const mq7Th = (thMq7!=null && !Number.isNaN(thMq7)) ? thMq7 : (Number.isFinite(mq7ThFallback) ? mq7ThFallback : null);
      const flTh  = (thFl!=null && !Number.isNaN(thFl)) ? thFl : (Number.isFinite(flThFallback) ? flThFallback : null);

      const overMq7 = (mq7Th!=null && Number.isFinite(mq7)) ? (mq7 >= mq7Th) : false;
      const overFl  = (flTh!=null && Number.isFinite(fl))  ? (fl  >= flTh)  : false;

      if (overMq7 && !lastOver.mq7){
        triggerAlarm(`MQ7 è¶…é˜ˆå€¼ï¼š${mq7.toFixed(2)} â‰¥ ${mq7Th.toFixed(2)}`);
      }
      if (overFl && !lastOver.flame){
        triggerAlarm(`ç«ç„°ç”µå‹è¶…é˜ˆå€¼ï¼š${fl.toFixed(2)} â‰¥ ${flTh.toFixed(2)}`);
      }

      if (!holdChk.checked && alarmActive && !overMq7 && !overFl){
        stopAlarm({ keepOverlay:false });
      }

      lastOver.mq7 = overMq7;
      lastOver.flame = overFl;
    };
  })();
  // ===================== /æŠ¥è­¦æé†’ =====================

  // å¯åŠ¨
  restoreInputs();
  setConn(false);
  connect();
</script>

  <!-- ============ æŠ¥è­¦æé†’ Overlay ============ -->
<div id="alarmOverlay" style="
  position:fixed;inset:0;display:none;z-index:99999;
  background:rgba(0,0,0,.65);backdrop-filter:blur(2px);
  align-items:center;justify-content:center;padding:16px;
">
  <div style="
    width:min(520px, 92vw); background:#fff; border-radius:14px;
    padding:16px 16px 12px; box-shadow:0 12px 40px rgba(0,0,0,.35);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  ">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div style="font-size:18px;font-weight:700;color:#b00020;">ğŸš¨ æŠ¥è­¦æé†’</div>
      <button id="alarmCloseBtn" style="
        border:none;background:#f2f2f2;border-radius:10px;padding:6px 10px;
        cursor:pointer;font-size:14px;
      ">å…³é—­</button>
    </div>

    <div id="alarmMessage" style="margin-top:10px;line-height:1.5;color:#111;font-size:15px;"></div>

    <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <button id="alarmAckBtn" style="
        border:none;background:#b00020;color:#fff;border-radius:12px;
        padding:10px 12px;cursor:pointer;font-weight:700;
      ">ç¡®è®¤å¹¶åœæ­¢</button>

      <button id="alarmSnoozeBtn" style="
        border:none;background:#ffb300;color:#111;border-radius:12px;
        padding:10px 12px;cursor:pointer;font-weight:700;
      ">ç¨å 5 åˆ†é’Ÿ</button>

      <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#333;">
        <input id="alarmHoldChk" type="checkbox" />
        ä¿æŒç›´åˆ°ç¡®è®¤ï¼ˆä¸è‡ªåŠ¨åœï¼‰
      </label>
    </div>

    <div style="margin-top:12px;padding-top:10px;border-top:1px solid #eee;
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <button id="alarmUnlockAudioBtn" style="
        border:none;background:#1976d2;color:#fff;border-radius:12px;
        padding:10px 12px;cursor:pointer;font-weight:700;
      ">ç‚¹æˆ‘æˆæƒ/è§£é”å£°éŸ³</button>

      <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#333;">
        <input id="alarmEnableChk" type="checkbox" checked />
        å¯ç”¨æŠ¥è­¦
      </label>

      <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#333;">
        <input id="alarmSoundChk" type="checkbox" checked />
        å£°éŸ³
      </label>

      <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#333;">
        <input id="alarmVibrateChk" type="checkbox" checked />
        éœ‡åŠ¨
      </label>

      <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#333;">
        <input id="alarmNotifyChk" type="checkbox" />
        é€šçŸ¥
      </label>

      <button id="alarmTestBtn" style="
        border:none;background:#2e7d32;color:#fff;border-radius:12px;
        padding:10px 12px;cursor:pointer;font-weight:700;
      ">æµ‹è¯•æŠ¥è­¦</button>

      <button id="alarmStopBtn" style="
        border:none;background:#616161;color:#fff;border-radius:12px;
        padding:10px 12px;cursor:pointer;font-weight:700;
      ">åœæ­¢</button>
    </div>

    <div id="alarmHint" style="margin-top:10px;font-size:12px;color:#666;"></div>
  </div>
</div>
<!-- ============ /æŠ¥è­¦æé†’ Overlay ============ -->

</body>
</html>
