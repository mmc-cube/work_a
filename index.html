<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>ESP32S3 控制面板</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --pri:#2563eb; --pri2:#1d4ed8; --ok:#16a34a; --bad:#e11d48; --warn:#f59e0b;
      --shadow:0 6px 18px rgba(15, 23, 42, .06);
      --appTop: 74px; /* ⭐ 顶部留白：被你App上方框遮挡的话，把这里调大/调小 */
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text);
    }
    .wrap{
      padding:12px;
      padding-top: calc(12px + var(--appTop) + env(safe-area-inset-top));
      max-width:520px; margin:0 auto;
    }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .title{ font-size:16px; font-weight:900; letter-spacing:.2px; }
    .badge{
      font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line);
      background:#fff; white-space:nowrap;
    }
    .badge.ok{ color:var(--ok); border-color:rgba(22,163,74,.25); background:rgba(22,163,74,.07); }
    .badge.bad{ color:var(--bad); border-color:rgba(225,29,72,.25); background:rgba(225,29,72,.06); }

    .grid{ display:grid; grid-template-columns:1fr; gap:10px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .mini{ padding:10px; }
    .mini .big{ font-size:26px; }
    .mini .sub{ font-size:11px; }
    .mini .alarmTag{ font-size:11px; padding:4px 8px; }

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:16px;
      padding:12px; box-shadow:var(--shadow);
    }
    .cardHead{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
    .name{ font-weight:900; }
    .sub{ color:var(--muted); font-size:12px; }
    .big{ font-size:34px; font-weight:950; line-height:1.05; margin:2px 0 0; letter-spacing:.2px; }
    .alarm{ border-color:rgba(225,29,72,.35); background:rgba(225,29,72,.04); }
    .alarmTag{
      font-size:12px; padding:5px 10px; border-radius:999px; color:#fff; background:var(--bad);
      white-space:nowrap;
    }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    input{
      width:100%; padding:11px 12px; border-radius:12px; border:1px solid var(--line);
      background:#fff; color:var(--text); outline:none; font-size:14px;
    }
    input::placeholder{ color:#94a3b8; }
    .btns{ display:flex; gap:10px; margin-top:8px; }
    button{
      flex:1; padding:11px 10px; border-radius:14px; border:1px solid var(--line);
      background:#fff; color:var(--text); font-weight:900; font-size:14px;
      box-shadow:0 6px 16px rgba(15, 23, 42, .05);
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{ background:var(--pri); border-color:rgba(37,99,235,.35); color:#fff; }
    button.primary:active{ background:var(--pri2); }
    button.warn{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#92400e; }
    button:active{ transform:scale(.99); }
    button:disabled{ opacity:.45; box-shadow:none; }

    .footer{
      margin-top:8px; color:var(--muted); font-size:12px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .hint{ color:var(--muted); }
  </style>
  <script src="./mqtt.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">ESP32S3 控制面板</div>
      <div id="connBadge" class="badge bad">离线</div>
    </div>

    <div class="grid">
      
      <div class="grid2">
        <div id="mq7Card" class="card mini">
          <div class="cardHead">
            <div>
              <div class="name">MQ7</div>
              <div class="sub">电压(V) · 阈值 <span id="mq7ThShow">--</span></div>
            </div>
            <div id="mq7AlarmTag" style="display:none" class="alarmTag">超阈值</div>
          </div>
          <div id="mq7V" class="big">--.--</div>
        </div>

        <div id="flameCard" class="card mini">
          <div class="cardHead">
            <div>
              <div class="name">火焰(AO)</div>
              <div class="sub">电压(V) · 阈值 <span id="flameThShow">--</span></div>
            </div>
            <div id="flameAlarmTag" style="display:none" class="alarmTag">超阈值</div>
          </div>
          <div id="flameV" class="big">--.--</div>
        </div>

        <div id="tempCard" class="card mini">
          <div class="cardHead">
            <div>
              <div class="name">温度</div>
              <div class="sub">℃ · 阈值 <span id="tempThShow">--</span></div>
            </div>
            <div id="tempAlarmTag" style="display:none" class="alarmTag">超阈值</div>
          </div>
          <div id="tempV" class="big">--.-</div>
        </div>

        <div id="humCard" class="card mini">
          <div class="cardHead">
            <div>
              <div class="name">湿度</div>
              <div class="sub">% · 阈值 <span id="humThShow">--</span></div>
            </div>
            <div id="humAlarmTag" style="display:none" class="alarmTag">超阈值</div>
          </div>
          <div id="humV" class="big">--.-</div>
        </div>
      </div>

<div class="card">
        <div class="cardHead">
          <div class="name">阈值设置</div>
          <div class="sub">电压 0~3.30V · 温度 -40~80℃ · 湿度 0~100%</div>
        </div>
        <div class="row">
          <input id="mq7ThIn" placeholder="mq7_th (V)" inputmode="decimal" />
          <input id="flameThIn" placeholder="flame_th (V)" inputmode="decimal" />
        </div>
        <div class="row" style="margin-top:8px">
          <input id="tempThIn" placeholder="temp_th (℃)" inputmode="decimal" />
          <input id="humThIn" placeholder="hum_th (%)" inputmode="decimal" />
        </div>
        <div class="btns">
          <button class="primary" id="btnSendTh">发送阈值</button>
          <button id="btnAutoFill">填入当前</button>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <div class="name">水泵控制</div>
          <div class="sub">GPIO6</div>
        </div>
        <div class="btns">
          <button class="primary" id="btnPumpOn">开泵</button>
          <button id="btnPumpOff">关泵</button>
          <button class="warn" id="btnPumpToggle">翻转</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div id="lastTs">last: --:--:--</div>
      <div id="hint" class="hint">自动连接中…</div>
    </div>
  </div>

<script>
  // ========= 固定协议（你需要的话可以只改 Broker）=========
  const BROKER_URL = "wss://test.mosquitto.org:8081";
  const MQTT_SUB_TOPIC = "fangmu/dev/esp32s3_001/up";    // 设备->上位机（订阅）
  const MQTT_PUB_TOPIC = "fangmu/dev/esp32s3_001/down";  // 上位机->设备（发布）
  // ==========================================================

  // 顶部留白可在这里改（也可只改 CSS 里的 --appTop）
  const APP_TOP_PX = 34;
  document.documentElement.style.setProperty("--appTop", APP_TOP_PX + "px");

  const MAX_V = 3.30;
  const TEMP_MIN = -40;
  const TEMP_MAX = 80;
  const HUM_MIN = 0;
  const HUM_MAX = 100;
  const STORAGE_KEY = "esp32s3_panel_v1";

  let client = null;
  let latest = { mq7_v:null, flame_v:null, temp_v:null, hum_v:null, mq7_th:null, flame_th:null, temp_th:null, hum_th:null };
  let connected = false;

  const $ = (id) => document.getElementById(id);
  const connBadge = $("connBadge");
  const hint = $("hint");
  const lastTs = $("lastTs");

  const btnSendTh = $("btnSendTh");
  const btnAutoFill = $("btnAutoFill");
  const btnPumpOn = $("btnPumpOn");
  const btnPumpOff = $("btnPumpOff");
  const btnPumpToggle = $("btnPumpToggle");

  const mq7ThIn = $("mq7ThIn");
  const flameThIn = $("flameThIn");
  const tempThIn = $("tempThIn");
  const humThIn = $("humThIn");

  function setButtonsEnabled(on){
    [btnSendTh, btnAutoFill, btnPumpOn, btnPumpOff, btnPumpToggle].forEach(b => b.disabled = !on);
  }

  function setConn(on){
    connected = on;
    connBadge.textContent = on ? "在线" : "离线";
    connBadge.className = "badge " + (on ? "ok" : "bad");
    hint.textContent = on ? "在线" : "离线";
    setButtonsEnabled(on);
  }

  function randomId(){
    return "web_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
  }

  function clampV(x){
    if (x == null || Number.isNaN(x)) return null;
    return Math.max(0, Math.min(MAX_V, Number(x)));
  }

  function clampTemp(x){
    if (x == null || Number.isNaN(x)) return null;
    return Math.max(TEMP_MIN, Math.min(TEMP_MAX, Number(x)));
  }

  function clampHum(x){
    if (x == null || Number.isNaN(x)) return null;
    return Math.max(HUM_MIN, Math.min(HUM_MAX, Number(x)));
  }


  function fmt2(v){
    return (v===null||v===undefined||Number.isNaN(v)) ? "--.--" : Number(v).toFixed(2);
  }

  function fmt1(v){
    return (v===null||v===undefined||Number.isNaN(v)) ? "--.-" : Number(v).toFixed(1);
  }


  // ===== 预警：通知 Android App（不改 UI，只加逻辑）=====
  // 需要 App 端：webView.addJavascriptInterface(..., "Android") 并实现 onAlarm(String json)
  const ALARM_COOLDOWN_MS = 30_000; // 同类告警最短间隔（防刷屏）
  let alarmState = { mq7:false, flame:false, temp:false, hum:false };
  let lastAlarmAt = { mq7:0, flame:0, temp:0, hum:0 };

  function notifyAndroid(payload){
    try{
      if (window.Android && typeof window.Android.onAlarm === "function"){
        window.Android.onAlarm(JSON.stringify(payload));
        return true;
      }
    }catch(_){}
    return false;
  }

  function pushAlarm(which){
    const now = Date.now();
    if (now - lastAlarmAt[which] < ALARM_COOLDOWN_MS) return;
    lastAlarmAt[which] = now;

    const payload = {
      type: "alarm",
      which, // "mq7" | "flame"
      ts: new Date().toISOString(),
      topic: MQTT_SUB_TOPIC,
      mq7_v: latest.mq7_v, mq7_th: latest.mq7_th,
      flame_v: latest.flame_v, flame_th: latest.flame_th,
      temp_v: latest.temp_v, temp_th: latest.temp_th,
      hum_v: latest.hum_v, hum_th: latest.hum_th
    };

    const ok = notifyAndroid(payload);

    // 复用现有 hint，不新增 UI
    hint.textContent = ok ? "已通知App" : "未接入App桥";
    setTimeout(()=> hint.textContent = connected ? "在线" : "离线", 800);
  }

  function updateUI(){
    $("mq7V").textContent = fmt2(latest.mq7_v);
    $("flameV").textContent = fmt2(latest.flame_v);
    $("tempV").textContent = fmt1(latest.temp_v);
    $("humV").textContent = fmt1(latest.hum_v);

    $("mq7ThShow").textContent = fmt2(latest.mq7_th);
    $("flameThShow").textContent = fmt2(latest.flame_th);
    $("tempThShow").textContent = fmt1(latest.temp_th);
    $("humThShow").textContent = fmt1(latest.hum_th);

    const mq7Alarm = latest.mq7_v!=null && latest.mq7_th!=null && Number(latest.mq7_v) >= Number(latest.mq7_th);
    const flameAlarm = latest.flame_v!=null && latest.flame_th!=null && Number(latest.flame_v) >= Number(latest.flame_th);
    const tempAlarm = latest.temp_v!=null && latest.temp_th!=null && Number(latest.temp_v) >= Number(latest.temp_th);
    const humAlarm = latest.hum_v!=null && latest.hum_th!=null && Number(latest.hum_v) >= Number(latest.hum_th);

    $("mq7Card").classList.toggle("alarm", mq7Alarm);
    $("mq7AlarmTag").style.display = mq7Alarm ? "inline-block" : "none";
    $("flameCard").classList.toggle("alarm", flameAlarm);
    $("flameAlarmTag").style.display = flameAlarm ? "inline-block" : "none";
    $("tempCard").classList.toggle("alarm", tempAlarm);
    $("tempAlarmTag").style.display = tempAlarm ? "inline-block" : "none";
    $("humCard").classList.toggle("alarm", humAlarm);
    $("humAlarmTag").style.display = humAlarm ? "inline-block" : "none";

    // ===== 超阈值 -> 触发预警（边沿触发：从正常变为告警才推送）=====
    if (mq7Alarm && !alarmState.mq7){ alarmState.mq7 = true; pushAlarm("mq7"); }
    if (!mq7Alarm && alarmState.mq7){ alarmState.mq7 = false; }

    if (flameAlarm && !alarmState.flame){ alarmState.flame = true; pushAlarm("flame"); }
    if (!flameAlarm && alarmState.flame){ alarmState.flame = false; }

    if (tempAlarm && !alarmState.temp){ alarmState.temp = true; pushAlarm("temp"); }
    if (!tempAlarm && alarmState.temp){ alarmState.temp = false; }

    if (humAlarm && !alarmState.hum){ alarmState.hum = true; pushAlarm("hum"); }
    if (!humAlarm && alarmState.hum){ alarmState.hum = false; }
  }

  function persistInputs(){
    const obj = { mq7: mq7ThIn.value, flame: flameThIn.value, temp: tempThIn.value, hum: humThIn.value };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
  }

  function restoreInputs(){
    try{
      const obj = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
      if (obj.mq7 != null) mq7ThIn.value = obj.mq7;
      if (obj.flame != null) flameThIn.value = obj.flame;
      if (obj.temp != null) tempThIn.value = obj.temp;
      if (obj.hum != null) humThIn.value = obj.hum;
    }catch(_){}
  }

  function publish(obj){
    if (!client || !connected) { hint.textContent = "未连接，无法发送"; return; }
    client.publish(MQTT_PUB_TOPIC, JSON.stringify(obj), { qos:0, retain:false });
    hint.textContent = "已发送";
    setTimeout(()=> hint.textContent = "在线", 700);
  }

  function connect(){
    if (client) { try{ client.end(true); }catch(_){} client = null; }

    hint.textContent = "自动连接中…";
    setButtonsEnabled(false);

    client = mqtt.connect(BROKER_URL, {
      clientId: randomId(),
      clean: true,
      keepalive: 30,
      connectTimeout: 10_000,
      reconnectPeriod: 2000,
    });

    client.on("connect", () => {
      setConn(true);
      client.subscribe(MQTT_SUB_TOPIC, { qos:0 });
    });

    client.on("reconnect", () => { hint.textContent = "重连中…"; });
    client.on("close", () => { setConn(false); });
    client.on("offline", () => { setConn(false); });
    client.on("error", () => { setConn(false); hint.textContent = "错误"; });

    client.on("message", (topic, message) => {
      if (topic !== MQTT_SUB_TOPIC) return;
      try{
        const data = JSON.parse(message.toString());

        // 取固定 8 字段（temp_v/hum_v 支持 null）
        if ("mq7_v" in data)   latest.mq7_v   = clampV(Number(data.mq7_v));
        if ("flame_v" in data) latest.flame_v = clampV(Number(data.flame_v));
        if ("temp_v" in data)  latest.temp_v  = (data.temp_v===null ? null : clampTemp(Number(data.temp_v)));
        if ("hum_v" in data)   latest.hum_v   = (data.hum_v===null ? null : clampHum(Number(data.hum_v)));

        if ("mq7_th" in data)   latest.mq7_th   = clampV(Number(data.mq7_th));
        if ("flame_th" in data) latest.flame_th = clampV(Number(data.flame_th));
        if ("temp_th" in data)  latest.temp_th  = clampTemp(Number(data.temp_th));
        if ("hum_th" in data)   latest.hum_th   = clampHum(Number(data.hum_th));

        updateUI();
        lastTs.textContent = "last: " + new Date().toLocaleTimeString();
      }catch(_){}
    });
  }

  // ===== 输入：离开输入框就存，并且自动夹紧到各自范围 =====
  function normalizeInput(el, clampFn, digits){
    const t = el.value.trim();
    if (!t) return;
    const v = clampFn(Number(t));
    el.value = (v==null) ? "" : Number(v).toFixed(digits);
    persistInputs();
  }
  mq7ThIn.addEventListener("blur", () => normalizeInput(mq7ThIn, clampV, 2));
  flameThIn.addEventListener("blur", () => normalizeInput(flameThIn, clampV, 2));
  tempThIn.addEventListener("blur", () => normalizeInput(tempThIn, clampTemp, 1));
  humThIn.addEventListener("blur", () => normalizeInput(humThIn, clampHum, 1));

  // ====== 按钮事件 ======
  btnAutoFill.onclick = () => {
    mq7ThIn.value = latest.mq7_th==null ? "" : fmt2(latest.mq7_th);
    flameThIn.value = latest.flame_th==null ? "" : fmt2(latest.flame_th);
    tempThIn.value = latest.temp_th==null ? "" : fmt1(latest.temp_th);
    humThIn.value = latest.hum_th==null ? "" : fmt1(latest.hum_th);
    persistInputs();
  };

  btnSendTh.onclick = () => {
    const mq7 = mq7ThIn.value.trim();
    const fl  = flameThIn.value.trim();
    const tp  = tempThIn.value.trim();
    const hm  = humThIn.value.trim();
    const cmd = { cmd:"set_th" };

    if (mq7 !== "") cmd.mq7_th = clampV(Number(mq7));
    if (fl !== "")  cmd.flame_th = clampV(Number(fl));
    if (tp !== "")  cmd.temp_th = clampTemp(Number(tp));
    if (hm !== "")  cmd.hum_th = clampHum(Number(hm));

    // 至少一个有效字段
    if (!("mq7_th" in cmd) && !("flame_th" in cmd) && !("temp_th" in cmd) && !("hum_th" in cmd)) { hint.textContent="请输入阈值"; return; }

    // 去掉 null
    if (cmd.mq7_th == null) delete cmd.mq7_th;
    if (cmd.flame_th == null) delete cmd.flame_th;
    if (cmd.temp_th == null) delete cmd.temp_th;
    if (cmd.hum_th == null) delete cmd.hum_th;

    publish(cmd);
  };

  btnPumpOn.onclick = () => publish({ cmd:"pump", state:1 });
  btnPumpOff.onclick = () => publish({ cmd:"pump", state:0 });
  btnPumpToggle.onclick = () => publish({ cmd:"pump", toggle:1 });

  // 页面显示/恢复时，确保连接存在（WebView 切后台再回来常见）
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) {
      // 若已断开则触发重连
      if (!client || !client.connected) connect();
    }
  });

  // 启动
  restoreInputs();
  setConn(false);
  connect();
</script>
</body>
</html>
